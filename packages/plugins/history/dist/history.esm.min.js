var D={maxHistory:50,shortcuts:!0},U={name:"history",init(b){let{eventBus:o,table:e,options:P}=b;if(!e){console.error("HistoryPlugin: table is undefined");return}let p={...D,...P},r=[],i=[],s=!1,c=null;function m(t){try{return JSON.parse(JSON.stringify(t))}catch(n){return console.error("HistoryPlugin: Failed to clone data",n),t}}function l(t){let n=e.getState();return{data:m(n.data),sort:n.sort?{...n.sort}:{column:null,direction:null},globalFilter:n.globalFilter||"",selected:[...n.selected||[]],_action:t,_timestamp:Date.now()}}function d(t){s||(r.push(t),r.length>p.maxHistory&&r.shift(),i.length=0,a())}function a(){o&&o.emit&&o.emit("history:change",{canUndo:r.length>0,canRedo:i.length>0,undoCount:r.length,redoCount:i.length})}function H(t){s=!0;try{e.setData&&e.setData(m(t.data)),t.sort&&t.sort.column&&e.sort&&e.sort(t.sort.column,t.sort.direction),t.globalFilter&&e.filter&&e.filter(t.globalFilter)}catch(n){console.error("HistoryPlugin: Failed to restore snapshot",n)}s=!1}function f(){if(r.length===0)return!1;let t=l("redo-point");i.push(t);let n=r.pop();return H(n),o&&o.emit&&o.emit("history:undo",{action:n._action}),a(),!0}function u(){if(i.length===0)return!1;let t=l("undo-point");r.push(t);let n=i.pop();return H(n),o&&o.emit&&o.emit("history:redo",{action:n._action}),a(),!0}function g(){return r.length>0}function h(){return i.length>0}function S(){r.length=0,i.length=0,a(),o&&o.emit&&o.emit("history:clear")}function k(){return{undoStack:[...r],redoStack:[...i],canUndo:g(),canRedo:h()}}return o&&o.on&&(o.on("cell:edit:start",t=>{s||(console.log("[History] cell:edit:start - pushing snapshot for:",t.columnId),d(l(`Edit ${t.columnId}`)))}),o.on("selection:change",t=>{s||t.count!==void 0&&(console.log("[History] selection:change - pushing snapshot, count:",t.count),d(l(`Selection (${t.count} rows)`)))}),o.on("edit:before",t=>{s||(console.log("[History] edit:before - pushing snapshot"),d(l("Edit cell")))}),o.on("row:update",t=>{})),p.shortcuts&&(c=t=>{if(!(navigator.platform.toUpperCase().indexOf("MAC")>=0?t.metaKey:t.ctrlKey))return;let y=t.key.toLowerCase();if(y==="z"&&!t.shiftKey){t.preventDefault(),t.stopPropagation(),console.log("[History] Undo triggered, stack size:",r.length);let v=f();console.log("[History] Undo result:",v);return}if(y==="y"){t.preventDefault(),t.stopPropagation(),console.log("[History] Redo (Y) triggered, stack size:",i.length),u();return}if(y==="z"&&t.shiftKey){t.preventDefault(),t.stopPropagation(),console.log("[History] Redo (Shift+Z) triggered, stack size:",i.length),u();return}},document.addEventListener("keydown",c,!0)),e.undo=f,e.redo=u,e.canUndo=g,e.canRedo=h,e.clearHistory=S,e.getHistory=k,{name:"history",undo:f,redo:u,canUndo:g,canRedo:h,clearHistory:S,getHistory:k,destroy(){c&&document.removeEventListener("keydown",c,!0),r.length=0,i.length=0,delete e.undo,delete e.redo,delete e.canUndo,delete e.canRedo,delete e.clearHistory,delete e.getHistory}}}};export{U as HistoryPlugin,U as default};
