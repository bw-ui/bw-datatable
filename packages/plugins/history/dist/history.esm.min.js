var D={maxHistory:50,trackSort:!1,trackFilter:!1,trackSelection:!1,shortcuts:!0},F={name:"history",init(l){let{eventBus:r,stateManager:k,table:i,options:x}=l,c={...D,...x},n=[],o=[],a=null,s=!1,f=null;function d(t){return JSON.parse(JSON.stringify(t))}function u(t){let e=k.getState();return{data:d(e.data),rows:d(e.rows),sort:[...e.sort],filters:{...e.filters},globalFilter:e.globalFilter,selected:[...e.selected],_action:t,_timestamp:Date.now()}}function h(t){s||(n.push(t),n.length>c.maxHistory&&n.shift(),o.length=0,p())}function p(){r.emit("history:change",{canUndo:n.length>0,canRedo:o.length>0,undoCount:n.length,redoCount:o.length})}function H(t){s=!0,k.setState({data:d(t.data),rows:d(t.rows),sort:[...t.sort],filters:{...t.filters},globalFilter:t.globalFilter,selected:new Set(t.selected)},{track:!1,silent:!0}),i.render(),s=!1}function y(){if(n.length===0)return!1;let t=u("redo-point");o.push(t);let e=n.pop();return H(e),r.emit("undo",{action:e._action,timestamp:e._timestamp}),p(),!0}function g(){if(o.length===0)return!1;let t=u("undo-point");n.push(t);let e=o.pop();return H(e),r.emit("redo",{action:e._action,timestamp:e._timestamp}),p(),!0}function m(){return n.length>0}function S(){return o.length>0}function w(){n.length=0,o.length=0,a=null,p(),r.emit("history:cleared")}function b(){return{undoStack:[...n],redoStack:[...o],canUndo:m(),canRedo:S()}}return r.on("edit:before",t=>{s||(a=u(`Edit [${t.rowId}][${t.columnId}]`))}),r.on("edit:end",t=>{s||(a&&t.value!==t.oldValue&&h(a),a=null)}),r.on("edit:cancel",()=>{a=null}),c.trackSort&&r.on("sort:before",()=>{s||h(u("Sort change"))}),c.trackFilter&&r.on("filter:before",()=>{s||h(u("Filter change"))}),c.shortcuts&&(f=t=>{if(t.target.matches("input, textarea, select")||!(navigator.platform.toUpperCase().indexOf("MAC")>=0?t.metaKey:t.ctrlKey))return;let v=t.key.toLowerCase(),C=v==="z"||t.keyCode===90,U=v==="y"||t.keyCode===89;if(C&&!t.shiftKey){t.preventDefault(),t.stopPropagation(),y();return}if(U){t.preventDefault(),t.stopPropagation(),g();return}if(C&&t.shiftKey){t.preventDefault(),t.stopPropagation(),g();return}},document.addEventListener("keydown",f,!0)),i.undo=y,i.redo=g,i.canUndo=m,i.canRedo=S,i.clearHistory=w,i.getHistory=b,{undo:y,redo:g,canUndo:m,canRedo:S,clearHistory:w,getHistory:b,destroy(){f&&document.removeEventListener("keydown",f,!0),n.length=0,o.length=0}}},destroy(l){l&&typeof l.destroy=="function"&&l.destroy()}};export{F as HistoryPlugin,F as default};
